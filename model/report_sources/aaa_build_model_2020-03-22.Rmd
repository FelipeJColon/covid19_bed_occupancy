---
title: "Forecasting bed occupancy from current admissions"
author: "Thibaut Jombart, Emily S Nightingale, Mark Jit, Olivier le Polain de Waroux, Gwen Knight, Stefan Flasche, Rosalind Eggo, Adam J Kucharski, Carl A.B. Pearson, Simon R Procter, CMMID nCov working group & W John Edmunds."
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: zenburn
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_collapse: no
    toc_depth: 4
    toc_float: yes
    css: !expr here::here('css', 'style.css')
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      collapse = TRUE,
                      fig.width = 8,
                      fig.height = 6,
                      dpi = 150,
                      warning = FALSE,
                      message = FALSE)
```



### What's in this document

This document provides an outline of the model and its implementation. It
returns a self-contained simulator as an `rds` object which can then be used as
backend in other systems (including the app provided in this repository).


### Rationale

This report outlines a model for forecasting bed occupancy from recent data on
admissions. In short, the process is as follows:

1. use a recent number of admissions at a given date as a point of reference

2. simulate growth in admissions from this point of reference using a branching
   process model, using recent estimates of the serial interval to model delay
   between generations of infections
   
3. for each simulated admission, simulate duration of hospitalisation from
   recent estimate of the duration of hospitalisation
   
4. derive daily numbers of bed needs



### Caveats

* The serial interval marks the delay between symptom onsets in successive
  cases. Using it as a proxy for the delay between generations of admissions, we
  implicitely assume a fixed, constant delay from onset to admission. This
  likely results in an under-estimation of the uncertainty in the bed needs
  predicted.

* Default distributions for the duration of stay are provided by matching results of 
[Zhou et al 2020](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30566-3/fulltext). 
These distributions may need changing under some settings.




<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# Data preparation {.tabset .tabset-fade .tabset-pills}

## Outline

* **Load scripts**: loads libraries and useful scripts used in the analyses; all
`.R` files contained in `scripts` at the root of the factory are automatically
loaded

* **Load data**: imports datasets, and may contain some *ad hoc* changes to the
data such as specific data cleaning (not used in other reports), new variables
used in the analyses, etc.



## Load packages

```{r libraries}

library(here)
library(reportfactory)
library(incidence)
library(distcrete)
library(epitrix)
library(tidyverse)
library(projections)

```



## Load scripts

These scripts will load:

* all local scripts, stored as `.R` filesinside `/scripts/`
* all global scripts, i.e. stored outside the factory in `../scripts/`

```{r read_scripts}

rfh_load_scripts()

```








<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# Proof of concept {.tabset .tabset-fade .tabset-pills}

## Model description

We aim to estimate the number of currently circulating cases on a
given day given a number of deaths reported recently. 

The principle of the estimation is:

1. augment the number of admissions using the reporting; currently this is just 
$n_{aug} = n_{reported} / reporting$

2. use a branching process with a Poisson distribution to simulate epidemic
   trajectories; see for instance 
   [Jombart et al 2020](https://www.eurosurveillance.org/content/10.2807/1560-7917.ES.2020.25.2.1900735); this is implemented by the RECON package [projections](http://www.repidemicsconsortium.org/projections/)
   
3. for each admission, simulate duration of hospitalisation from provided distribution

4. count beds for each day and simulation


 


## Parameters of the model

This section contain information on the various parameters. We use these
data to generate distribution, with discretisation when needed.

* **serial interval**: 
    + mean of 4.7 days, s.d. of 2.9 days (log normal distribution fit)
    + [source](https://www.medrxiv.org/content/10.1101/2020.02.03.20019497v2.full.pdf.)

```{r serial_interval}

serial_interval <- distcrete("lnorm", w = 0, interval = 1,
                             meanlog = log(4.7),
                             sdlog = log(2.9))

```
* **Duration of hospitalisation**:
    + non critical care: discretised Weibull(shape:, scale:) to aim for a median of 11
      days, IQR 7-14
    + critical care: discretised Weibull(shape:2, scale:10) to aim for a median of 8
      days, IQR 4-12
    + See table 2 in 
	[source](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30566-3/fulltext)

```{r los}

## los = "length of stay"
## los_critical for critical care
los_critical <- distcrete("weibull", shape = 2, scale = 10, w = 0, interval = 1)

## los_normal for non critical care hospitalisation
los_normal <- distcrete("weibull", shape = 2, scale = 13, w = 0, interval = 1)

## ## auxiliary function for manual exploration of distributions
## try <- function(shape, scale) {
##   x <- distcrete("weibull", shape = shape, scale = scale, w = 0, interval = 1)$r(1e5)
##   hist(x)
##   summary(x)
## }

```



## Serial interval

We visualise the probabiliy mass function for the first 50 days:

```{r serial_interval_plot}

plot(0:50, serial_interval$d(0:50),
     type = "h", col = "#5E9281", lwd = 8, lend = 2,
     xlab = "Days from primary to secondary admission",
     ylab = "Probability",
     main = "Delay between generations of admissions",
     cex.lab = 1.3, cex.main = 1.5)

```



## Duration of hospitalisation

We visualise the probabiliy mass functions for the first 50 days:

```{r los_plot}

plot(0:50, los_normal$d(0:50),
     type = "h", col = "#e6b800", lwd = 8, lend = 2,
     xlab = "Days in hospital",
     ylab = "Probability",
     main = "Duration of non-critical hospitalisation",
     cex.lab = 1.3, cex.main = 1.5)


plot(0:50, los_critical$d(0:50),
     type = "h", col = "#ff944d", lwd = 8, lend = 2,
     xlab = "Days in hospital",
     ylab = "Probability",
     main = "Duration of critical care hospitalisation",
     cex.lab = 1.3, cex.main = 1.5)

```




## Illustration

As an illustration, we forecast bed occupancy for 2 weeks in a hypothetical location which
would have reported 65 admissions on the current day, with an assumed reporting
of 80% and an assumed R of 2.

```{r illustration}

## input parameters
R <- 2
reporting <- 0.8
date_start <- Sys.Date()
n_start <- 65
n_sim <- 50
duration <- 14
last_date <- date_start + duration
los_r <- los_critical$r

## make case forecasting, assuming R = 2
## we simulate `n_sim` trajectories from a Poisson model
proj_admissions <- rep(date_start, n_start) %>%
  incidence() %>%
  project(R = 2, si = serial_interval, n_sim = n_sim, n_days = duration)

plot(proj_admissions) +
  theme_bw() +
  large_txt +
  scale_x_date(date_labels = "%d %b %Y") +
  rotate_x +
  labs(y = "Daily admissions",
       title = "Forecast of daily admissions")


## simulate durations of hospitalisation
list_dates_admissions <- lapply(
    seq_len(ncol(proj_admissions)),
    function(n_cases) rep(get_dates(proj_admissions), n_cases))


## this function takes as input a vector of dates of admissions, and outputs a
## projections object counting daily bed requirements; `n_replicates` gives a handle on
## the number of replicates to perform (as duration of hospitalisation itself is
## stochastic)

simulate_beds <- function(dates_admission,
                          n_replicates = 1,
                          last_date = NULL) {

  n <- length(dates_admission)

  out <- vector(n_replicates, mode = "list")

  for (j in seq_len(n_replicates)) {
    durations <- los_r(n)
    list_dates_beds <- lapply(seq_len(n),
                              function(i) seq(dates_admission[i],
                                              length.out = durations[i],
                                              by = 1L))
    dates_beds <- do.call(c, list_dates_beds)
    beds_days <- incidence(dates_beds)
    if (!is.null(last_date)) {
      to_keep <- get_dates(beds_days) <= last_date
      beds_days <- beds_days[to_keep, ]
    }

    out[[j]] <- build_projections(x = beds_days$counts,
                                  dates = get_dates(beds_days))
  }

  merge_projections(out)
  
}



## simulator for ICU beds
project_icu_beds <- function(dates, cases, r_duration) {
  
  sim_admission <- rep(dates, cases)
  n <- length(sim_admission)
  sim_duration <- r_duration(n)
  
  out <- lapply(seq_len(n), function(i) seq(sim_admission[i],
                                            length.out = sim_duration[i],
                                            by = 1L))
  out <- do.call(c, out)
  out <- incidence::incidence(out)

  ## remove last days (artificial decrease)
  last_day <- max(dates)
  out[get_dates(out) <= last_day, ]
}



## simulate beds for each epicurve
list_sims <- lapply(list_dates_admissions,
                    simulate_beds,
                    n_replicates = 1,
                    last_date = last_date)

## merge results
beds <- merge_projections(list_sims)

## plot results
plot(beds,
     quantiles = FALSE,
     ribbon = FALSE,
     boxplots = TRUE,
     boxplots_fill = "#a3a3c2",
     boxplots_color = "#3d3d5c") +
  theme_bw() +
  large_txt +
  scale_x_date(date_label = "%d %b %y") +
  rotate_x +
  labs(title = "Predicted bed occupancy",
       x = NULL,
       y = "Daily numbers of beds")

```








<!-- ======================================================= --> 
<!-- ======================================================= --> 
<!-- ======================================================= -->

# Export {.tabset .tabset-fade .tabset-pills}

## Simulator

The simulator is exported as an `rds` file. Because it uses closure programming,
it should be functional out-of-the box, without having to re-specify the
delay distributions.

```{r export_rds, eval = FALSE}

if (!dir.exists("rds_outputs")) {
  dir.create("rds_outputs")
}

## export to local folder
rio::export(simulate_cases,
            file = "rds_outputs/simulate_cases.rds")
rio::export(simulate_cases_alternative,
            file = "rds_outputs/simulate_cases_alternative.rds")

## export to main rds folder
rio::export(simulate_cases,
            file = here("rds", "simulate_cases.rds"))
rio::export(simulate_cases_alternative,
            file = here("rds", "simulate_cases_alternative.rds"))

## export to the app's folder
rio::export(simulate_cases,
            file = here("..", "app", "rds", "simulate_cases.rds"))
rio::export(simulate_cases_alternative,
            file = here("..", "app", "rds", "simulate_cases_alternative.rds"))

```





<!-- ======================================================= --> 
<!-- ======================================================= --> 
<!-- ======================================================= -->

# System information {.tabset .tabset-fade .tabset-pills}

## Outline

The following information documents the system on which the document was
compiled.


## System 

This provides information on the operating system.

```{r system_info}
Sys.info()
```

## R environment

This provides information on the version of R used:

```{r R_session}
R.version
```


## R packages

This provides information on the packages used:

```{r R_pkg}
sessionInfo()
```
